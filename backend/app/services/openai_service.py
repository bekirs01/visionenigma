"""
OpenAI –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–∏–∫–µ—Ç–æ–≤ –≠–†–ò–°: –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö + –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞.
"""
from typing import Tuple, Dict, Any, Optional, List
from dataclasses import dataclass
import json
from app.config import get_settings


@dataclass
class ErisAnalysisResult:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –ø–∏—Å—å–º–∞ –¥–ª—è –∫–µ–π—Å–∞ –≠–†–ò–°"""
    sender_full_name: Optional[str] = None
    object_name: Optional[str] = None
    sender_phone: Optional[str] = None
    serial_numbers: Optional[List[str]] = None
    device_type: Optional[str] = None
    sentiment: str = "neutral"
    request_category: str = "–¥—Ä—É–≥–æ–µ"
    issue_summary: Optional[str] = None
    reply: str = ""
    category: str = "other"  # legacy compatibility
    operator_required: bool = False
    operator_reason: Optional[str] = None


# 20 –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞–ø—Ä–æ—Å–æ–≤ (whitelist). AI –æ–±—è–∑–∞–Ω –≤—ã–±—Ä–∞—Ç—å –æ–¥–Ω—É. "–¥—Ä—É–≥–æ–µ" ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∏ –æ–¥–Ω–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç.
ALLOWED_CATEGORIES = [
    "–Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å",
    "–∫–∞–ª–∏–±—Ä–æ–≤–∫–∞",
    "–∑–∞–ø—Ä–æ—Å_–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏",
    "–≥–∞—Ä–∞–Ω—Ç–∏—è",
    "–∑–∞–º–µ–Ω–∞_–¥–∞—Ç—á–∏–∫–∞",
    "–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è",
    "—ç–∫–∑–∞–º–µ–Ω",
    "–ø–µ—Ä–µ—Å–¥–∞—á–∞",
    "–æ–ø–ª–∞—Ç–∞",
    "–¥–æ–≥–æ–≤–æ—Ä",
    "–≤–æ–∑–≤—Ä–∞—Ç",
    "–∂–∞–ª–æ–±–∞",
    "—Å—Ä–æ—á–Ω—ã–π_–≤—ã–∑–æ–≤",
    "–º–æ–Ω—Ç–∞–∂",
    "–ø–æ—Å—Ç–∞–≤–∫–∞",
    "–æ–±—É—á–µ–Ω–∏–µ",
    "—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è",
    "—Ä–µ–º–æ–Ω—Ç",
    "–∞–ø–≥—Ä–µ–π–¥",
    "–¥—Ä—É–≥–æ–µ",
]
CATEGORY_LABELS_RU = {
    "–Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å": "–ù–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å",
    "–∫–∞–ª–∏–±—Ä–æ–≤–∫–∞": "–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞",
    "–∑–∞–ø—Ä–æ—Å_–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏": "–ó–∞–ø—Ä–æ—Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏",
    "–≥–∞—Ä–∞–Ω—Ç–∏—è": "–ì–∞—Ä–∞–Ω—Ç–∏—è",
    "–∑–∞–º–µ–Ω–∞_–¥–∞—Ç—á–∏–∫–∞": "–ó–∞–º–µ–Ω–∞ –¥–∞—Ç—á–∏–∫–∞",
    "–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è": "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è",
    "—ç–∫–∑–∞–º–µ–Ω": "–≠–∫–∑–∞–º–µ–Ω / –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è",
    "–ø–µ—Ä–µ—Å–¥–∞—á–∞": "–ü–µ—Ä–µ—Å–¥–∞—á–∞",
    "–æ–ø–ª–∞—Ç–∞": "–û–ø–ª–∞—Ç–∞ / —Å—á—ë—Ç",
    "–¥–æ–≥–æ–≤–æ—Ä": "–î–æ–≥–æ–≤–æ—Ä",
    "–≤–æ–∑–≤—Ä–∞—Ç": "–í–æ–∑–≤—Ä–∞—Ç",
    "–∂–∞–ª–æ–±–∞": "–ñ–∞–ª–æ–±–∞",
    "—Å—Ä–æ—á–Ω—ã–π_–≤—ã–∑–æ–≤": "–°—Ä–æ—á–Ω—ã–π –≤—ã–∑–æ–≤",
    "–º–æ–Ω—Ç–∞–∂": "–ú–æ–Ω—Ç–∞–∂ / —É—Å—Ç–∞–Ω–æ–≤–∫–∞",
    "–ø–æ—Å—Ç–∞–≤–∫–∞": "–ü–æ—Å—Ç–∞–≤–∫–∞ / –¥–æ—Å—Ç–∞–≤–∫–∞",
    "–æ–±—É—á–µ–Ω–∏–µ": "–û–±—É—á–µ–Ω–∏–µ",
    "—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è": "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è",
    "—Ä–µ–º–æ–Ω—Ç": "–†–µ–º–æ–Ω—Ç",
    "–∞–ø–≥—Ä–µ–π–¥": "–ê–ø–≥—Ä–µ–π–¥ / –º–æ–¥–µ—Ä–Ω–∏–∑–∞—Ü–∏—è",
    "–¥—Ä—É–≥–æ–µ": "–î—Ä—É–≥–æ–µ",
}
# –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
ERIS_CATEGORIES = ALLOWED_CATEGORIES

# –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏/–∫—Ä–∏–∑–∞: –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –≤ —Ç–µ–º–µ –∏–ª–∏ —Ç–µ–ª–µ ‚Äî operator_required = true (heuristic override)
URGENT_KEYWORDS = [
    "—Å—Ä–æ—á–Ω–æ", "—Å—Ä–æ—á–Ω–∞—è", "—Å—Ä–æ—á–Ω—ã–π", "–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ", "asap", "—ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ", "—Å–µ–≥–æ–¥–Ω—è", "–ø—Ä—è–º–æ —Å–µ–π—á–∞—Å",
    "–∫—Ä–∏—Ç–∏—á–Ω–æ", "–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è", "–∞–≤–∞—Ä–∏—è", "–∞–≤–∞—Ä–∏–π–Ω", "–ø—Ä–æ—Å—Ç–æ–π", "–æ–ø–∞—Å–Ω–æ", "–æ–ø–∞—Å–Ω–æ—Å—Ç—å",
    "—É–≥—Ä–æ–∑–∞", "—É—Ç–µ—á–∫–∞", "–≤–∑–ª–æ–º", "–º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ", "–∂–∞–ª–æ–±–∞", "—Å—É–¥", "–ø—Ä–æ–∫—É—Ä–∞—Ç—É—Ä–∞",
    "–æ–ø–ª–∞—Ç–∞", "—Å—á–µ—Ç", "—Å—á—ë—Ç", "–≤–æ–∑–≤—Ä–∞—Ç", "–¥–æ—Å—Ç—É–ø", "–∞–∫–∫–∞—É–Ω—Ç", "–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏", "–Ω–µ –º–æ–≥—É –≤–æ–π—Ç–∏",
    "–ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç–µ", "–Ω—É–∂–µ–Ω —á–µ–ª–æ–≤–µ–∫", "–Ω—É–∂–µ–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä", "—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä",
    "–∂–∏–≤–æ–π –æ–ø–µ—Ä–∞—Ç–æ—Ä", "—Å—Ä–æ—á–Ω–æ –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç–µ", "—Å—Ä–æ—á–Ω–æ —Å–≤—è–∂–∏—Ç–µ—Å—å",
]

DEFAULT_OPERATOR_REASON = "–ó–∞–ø—Ä–æ—Å –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ —Å—Ä–æ—á–Ω—ã–π ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞."


def _apply_operator_heuristic(subject: str, body: str, result: ErisAnalysisResult) -> None:
    """–ï—Å–ª–∏ –≤ —Ç–µ–º–µ –∏–ª–∏ —Ç–µ–ª–µ –µ—Å—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ operator_required = true."""
    text = f"{subject or ''} {body or ''}".lower()
    for kw in URGENT_KEYWORDS:
        if kw in text:
            result.operator_required = True
            result.operator_reason = (result.operator_reason or DEFAULT_OPERATOR_REASON)[:120]
            return


def analyze_with_openai(subject: str, body: str, kb_context: str = "") -> Tuple[str, str]:
    """
    Legacy —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏: (–∫–∞—Ç–µ–≥–æ—Ä–∏—è, –æ—Ç–≤–µ—Ç).
    """
    result = analyze_eris_email(subject, body, "", kb_context)
    return result.category, result.reply


def analyze_eris_email(
    subject: str,
    body: str,
    sender_email: str = "",
    kb_context: str = ""
) -> ErisAnalysisResult:
    """
    –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–∏—Å—å–º–∞ –¥–ª—è –∫–µ–π—Å–∞ –≠–†–ò–° (–≥–∞–∑–æ–∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—ã).

    –ò–∑–≤–ª–µ–∫–∞–µ—Ç:
    - –§–ò–û –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
    - –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è/–æ–±—ä–µ–∫—Ç–∞
    - –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω
    - –ó–∞–≤–æ–¥—Å–∫–∏–µ –Ω–æ–º–µ—Ä–∞ –ø—Ä–∏–±–æ—Ä–æ–≤
    - –¢–∏–ø/–º–æ–¥–µ–ª—å –ø—Ä–∏–±–æ—Ä–æ–≤
    - –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ–∫—Ä–∞—Å
    - –ö–∞—Ç–µ–≥–æ—Ä–∏—é –∑–∞–ø—Ä–æ—Å–∞
    - –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
    - –û—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
    """
    settings = get_settings()
    if not (settings.openai_api_key and settings.openai_api_key.strip()):
        raise ValueError(
            "OPENAI_API_KEY bulunamadƒ±. Proje k√∂k√ºndeki .env dosyasƒ±nƒ± olu≈üturun; .env.example dosyasƒ±ndan kopyalayƒ±p anahtarƒ±nƒ±zƒ± yazƒ±n."
        )

    from openai import OpenAI
    client = OpenAI(api_key=settings.openai_api_key.strip())

    system_prompt = """–¢—ã ‚Äî AI-–∞–≥–µ–Ω—Ç —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–æ–º–ø–∞–Ω–∏–∏ –û–û–û ¬´–≠–†–ò–°¬ª (–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å –≥–∞–∑–æ–∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–æ–≤ –∏ –≥–∞–∑–æ—Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–æ–≤).

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–†–ê–ó–î–ï–õ 1: –ó–ù–ê–ù–ò–Ø –≠–†–ò–°
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–¢–ò–ü–´ –ü–†–û–î–£–ö–¶–ò–ò –≠–†–ò–°:
- –ì–∞–∑–æ–∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—ã —Å–µ—Ä–∏–∏: –≠–†–ò–°-210, –≠–†–ò–°-230, –≠–†–ò–°-310, –≠–†–ò–°-–§–ò–î, –î–ì–°-–≠–†–ò–°-230, IR-G20
- –ì–∞–∑–æ—Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—ã: –ì–°–ú-05, –ì–°–ú-10, –ì–°-–°–û, –ì–∞–∑–∫–æ–Ω—Ç—Ä–æ–ª—å-01
- –î–∞—Ç—á–∏–∫–∏: –î–ì–°-–≠–†–ò–° (–Ω–∞ —Ä–∞–∑–Ω—ã–µ –≥–∞–∑—ã: –º–µ—Ç–∞–Ω CH4, –°–û, H2S, O2, –∏ –¥—Ä.)
- –°–∏—Å—Ç–µ–º—ã: –°–ì–ö, –°–ò–ö–ó, –ê–°–£ –¢–ü
- –ü–û: –≠–†–ò–° 210, DGS BLE (Android)

–û–§–ò–¶–ò–ê–õ–¨–ù–´–ï –†–ï–°–£–†–°–´ (–º–æ–∂–Ω–æ –¥–∞–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞–º):
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞: https://eriskip.com/ru/products
- –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã: ATEX, IECEx, –†–æ—Å—Å—Ç–∞–Ω–¥–∞—Ä—Ç, –¢–∞–º–æ–∂–µ–Ω–Ω—ã–π —Å–æ—é–∑

–í–ê–ñ–ù–û: –§–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π FAQ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –û–±—Ä–∞—â–µ–Ω–∏—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã –ø–æ —Ñ–æ—Ä–º–∞—Ç—É: —Ç–µ–∫—Å—Ç, –≤–ª–æ–∂–µ–Ω–∏—è, –ø–∏—Å—å–º–∞ –±–µ–∑ –±–∞–∑–æ–≤—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤. –ú–Ω–æ–≥–æ–∫–∞–Ω–∞–ª—å–Ω–æ—Å—Ç—å: –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–∞–ø—Ä—è–º—É—é –∏ —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–†–ê–ó–î–ï–õ 2: –¢–í–û–Ø –ó–ê–î–ê–ß–ê
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–µ–µ –ø–∏—Å—å–º–æ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
2. –ò–∑–≤–ª–µ—á—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
3. –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–µ–∑–Ω—ã–π –æ—Ç–≤–µ—Ç —Å —É—Ç–æ—á–Ω—è—é—â–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –í–µ–∂–ª–∏–≤–æ, –ø–æ –¥–µ–ª—É, –±–µ–∑ ¬´–≤–æ–¥—ã¬ª
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π ‚Äî –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –∑–∞–¥–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
- –ï—Å–ª–∏ –Ω–µ—Ç —Ä–µ—à–µ–Ω–∏—è ‚Äî –Ω–∞–ø—Ä–∞–≤—å –∫ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —ç—Å–∫–∞–ª–∞—Ü–∏—é —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–†–ê–ó–î–ï–õ 3: –ö–ê–¢–ï–ì–û–†–ò–ò –ó–ê–ü–†–û–°–û–í (–≤—ã–±–µ—Ä–∏ –†–û–í–ù–û –û–î–ù–£)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

1. –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å ‚Äî –ø—Ä–∏–±–æ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ—à–∏–±–∫–∏, –Ω–µ–≤–µ—Ä–Ω—ã–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è, –ª–æ–∂–Ω—ã–µ —Ç—Ä–µ–≤–æ–≥–∏
2. –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ ‚Äî –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞, –ø–æ–≤–µ—Ä–∫–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
3. –∑–∞–ø—Ä–æ—Å_–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ‚Äî –ø–∞—Å–ø–æ—Ä—Ç, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç, —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ, –º–µ—Ç–æ–¥–∏–∫–∞
4. –≥–∞—Ä–∞–Ω—Ç–∏—è ‚Äî –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç, –∑–∞–º–µ–Ω–∞ –ø–æ –≥–∞—Ä–∞–Ω—Ç–∏–∏
5. –∑–∞–º–µ–Ω–∞_–¥–∞—Ç—á–∏–∫–∞ ‚Äî –∑–∞–º–µ–Ω–∞ —Å–µ–Ω—Å–æ—Ä–∞, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
6. –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è ‚Äî –≤–æ–ø—Ä–æ—Å—ã –ø–æ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏, –≤—ã–±–æ—Ä—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, —Å—Ö–µ–º—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
7. —ç–∫–∑–∞–º–µ–Ω ‚Äî —ç–∫–∑–∞–º–µ–Ω, –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞–Ω–∏–π
8. –ø–µ—Ä–µ—Å–¥–∞—á–∞ ‚Äî –ø–µ—Ä–µ—Å–¥–∞—á–∞ —ç–∫–∑–∞–º–µ–Ω–∞, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è
9. –æ–ø–ª–∞—Ç–∞ ‚Äî –æ–ø–ª–∞—Ç–∞, —Å—á—ë—Ç, –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç–∞
10. –¥–æ–≥–æ–≤–æ—Ä ‚Äî –¥–æ–≥–æ–≤–æ—Ä, —É—Å–ª–æ–≤–∏—è, –¥–æ–ø—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ
11. –≤–æ–∑–≤—Ä–∞—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—Ç —Ç–æ–≤–∞—Ä–∞, –¥–µ–Ω–µ–≥
12. –∂–∞–ª–æ–±–∞ ‚Äî –∂–∞–ª–æ–±–∞ –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, —Å–µ—Ä–≤–∏—Å
13. —Å—Ä–æ—á–Ω—ã–π_–≤—ã–∑–æ–≤ ‚Äî —Å—Ä–æ—á–Ω—ã–π –≤—ã–µ–∑–¥, —Å—Ä–æ—á–Ω–∞—è –∑–∞—è–≤–∫–∞
14. –º–æ–Ω—Ç–∞–∂ ‚Äî –º–æ–Ω—Ç–∞–∂, —É—Å—Ç–∞–Ω–æ–≤–∫–∞, —à–µ—Ñ-–º–æ–Ω—Ç–∞–∂
15. –ø–æ—Å—Ç–∞–≤–∫–∞ ‚Äî –ø–æ—Å—Ç–∞–≤–∫–∞, –¥–æ—Å—Ç–∞–≤–∫–∞, —Å—Ä–æ–∫–∏
16. –æ–±—É—á–µ–Ω–∏–µ ‚Äî –æ–±—É—á–µ–Ω–∏–µ, –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂
17. —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ‚Äî —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è, –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏
18. —Ä–µ–º–æ–Ω—Ç ‚Äî —Ä–µ–º–æ–Ω—Ç (–≤–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏)
19. –∞–ø–≥—Ä–µ–π–¥ ‚Äî –∞–ø–≥—Ä–µ–π–¥, –º–æ–¥–µ—Ä–Ω–∏–∑–∞—Ü–∏—è
20. –¥—Ä—É–≥–æ–µ ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∏ –æ–¥–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –≤—ã—à–µ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–†–ê–ó–î–ï–õ 4: –®–ê–ë–õ–û–ù–´ –£–¢–û–ß–ù–Ø–Æ–©–ò–• –í–û–ü–†–û–°–û–í –ü–û –¢–ò–ü–û–í–´–ú –ö–ï–ô–°–ê–ú
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ü—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–ø—Ä–∞—à–∏–≤–∞–π –Ω–µ–¥–æ—Å—Ç–∞—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:

üì± DGS BLE Android (–∑–∞–ø—Ä–æ—Å –ø–∞—Ä–æ–ª—è/–¥–æ—Å—Ç—É–ø–∞):
- –§–ò–û, –¥–æ–ª–∂–Ω–æ—Å—Ç—å, –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ (–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è), –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω
- ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)

üîå Modbus/RS-485 (–ø—Ä–æ–±–ª–µ–º—ã —Å–≤—è–∑–∏, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ü–õ–ö):
- –°—Ö–µ–º–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (—Ç–æ–ø–æ–ª–æ–≥–∏—è —Å–µ—Ç–∏)
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–∏–Ω–∏–∏: baud rate, parity, stop bits
- –î–ª–∏–Ω–∞ –ª–∏–Ω–∏–∏, —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ç–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä—ã
- –ú–æ–¥–µ–ª—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ (Siemens S7-1200, –∏ –¥—Ä.)
- –ê–¥—Ä–µ—Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ Modbus
- –ñ—É—Ä–Ω–∞–ª –æ—à–∏–±–æ–∫ / —Å–∏–º–ø—Ç–æ–º—ã

üíª –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ / –ü–û –≠–†–ò–° 210 (—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è):
- –í–µ—Ä—Å–∏—è –ü–û –≠–†–ò–° 210 –∏ –û–° (Windows 7/10/11)
- –¢–∏–ø –∫–∞–±–µ–ª—è/–∞–¥–∞–ø—Ç–µ—Ä–∞ (USB-RS485, COM-–ø–æ—Ä—Ç)
- –î—Ä–∞–π–≤–µ—Ä—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã? –ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞?
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–∞–µ–º—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –õ–æ–≥–∏/—Å–∫—Ä–∏–Ω—à–æ—Ç—ã –æ—à–∏–±–æ–∫

üå°Ô∏è –õ–æ–∂–Ω—ã–µ —Ç—Ä–µ–≤–æ–≥–∏ –ø—Ä–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ/–≤–ª–∞–∂–Ω–æ—Å—Ç–∏:
- –¢–∏–ø –¥–∞—Ç—á–∏–∫–∞/—Å–µ–Ω—Å–æ—Ä–∞, –º–æ–¥–µ–ª—å, –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è (—Å—É—Ñ—Ñ–∏–∫—Å W00 –∏ —Ç.–¥.)
- –î–∏–∞–ø–∞–∑–æ–Ω –∏–∑–º–µ—Ä–µ–Ω–∏–π
- –£—Å–ª–æ–≤–∏—è —Å—Ä–µ–¥—ã: —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –≤–ª–∞–∂–Ω–æ—Å—Ç—å, –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–∞
- –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –º–æ–Ω—Ç–∞–∂–∞, –Ω–∞–ª–∏—á–∏–µ –≤–∏–±—Ä–∞—Ü–∏–π/–≠–ú-–ø–æ–º–µ—Ö
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏/–ø–æ—Ä–æ–≥–æ–≤ —Ç—Ä–µ–≤–æ–≥
- –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–≤–µ—Ä–∫–∏/–∫–∞–ª–∏–±—Ä–æ–≤–∫–∏

üìÑ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã/–¥–æ–∫—É–º–µ–Ω—Ç—ã:
- –¢–æ—á–Ω–∞—è –º–æ–¥–µ–ª—å –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏–±–æ—Ä–∞
- –ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã: ATEX, IECEx, –¢–°, –†–æ—Å—Å—Ç–∞–Ω–¥–∞—Ä—Ç?
- –°—Ä–æ–∫/—Ä–µ–¥–∞–∫—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –∞—É–¥–∏—Ç, –ø—Ä–æ–µ–∫—Ç, –≤–≤–æ–¥ –≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é?

üìã –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ (–∑–∞–ø—Ä–∞—à–∏–≤–∞–π –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã):
- –ú–æ–¥–µ–ª—å/–º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è/—Å—É—Ñ—Ñ–∏–∫—Å –ø—Ä–∏–±–æ—Ä–∞
- –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä (–∑–∞–≤–æ–¥—Å–∫–æ–π –Ω–æ–º–µ—Ä)
- –í–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏/firmware
- –§–æ—Ç–æ —à–∏–ª—å–¥–∏–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–†–ê–ó–î–ï–õ 5: –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –ò–ó –ü–ò–°–¨–ú–ê
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

1. –§–ò–û: –∏—â–∏ –≤ –ø–æ–¥–ø–∏—Å–∏, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–∏ ("–° —É–≤–∞–∂–µ–Ω–∏–µ–º, ...", "–ò–≤–∞–Ω–æ–≤ –ò.–ò.")
2. –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è: –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è, –∑–∞–≤–æ–¥–∞, –æ–±—ä–µ–∫—Ç–∞
3. –¢–µ–ª–µ—Ñ–æ–Ω: –ª—é–±–æ–π –Ω–æ–º–µ—Ä –≤ —Ç–µ–∫—Å—Ç–µ (+7, 8-..., –∏ —Ç.–¥.)
4. –ó–∞–≤–æ–¥—Å–∫–∏–µ –Ω–æ–º–µ—Ä–∞: —Ñ–æ—Ä–º–∞—Ç "–ó–ù: 12345", "‚Ññ12345", "s/n", –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ
5. –¢–∏–ø –ø—Ä–∏–±–æ—Ä–∞: –º–æ–¥–µ–ª—å (–≠–†–ò–°-210, –î–ì–°-–≠–†–ò–°-230, IR-G20 –∏ —Ç.–¥.)

–≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–´–ô –û–ö–†–ê–°:
- "negative" ‚Äî –∫–ª–∏–µ–Ω—Ç —Ä–∞—Å—Å—Ç—Ä–æ–µ–Ω, –∂–∞–ª—É–µ—Ç—Å—è, –Ω–µ–¥–æ–≤–æ–ª–µ–Ω, –ø—Ä–µ—Ç–µ–Ω–∑–∏—è
- "neutral" ‚Äî –æ–±—ã—á–Ω—ã–π –¥–µ–ª–æ–≤–æ–π —Ç–æ–Ω
- "positive" ‚Äî –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å

{kb_section}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–†–ê–ó–î–ï–õ 6: –ü–û–õ–ò–¢–ò–ö–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò –ò –ê–ù–¢–ò-–ì–ê–õ–õ–Æ–¶–ò–ù–ê–¶–ò–ò
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ó–ê–ü–†–ï–©–ï–ù–û:
- –í—ã–¥—É–º—ã–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- –û–±–µ—â–∞—Ç—å —Ç–æ, —á–µ–≥–æ –Ω–µ—Ç –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö
- –†–∞—Å–∫—Ä—ã–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (–§–ò–û, —Ç–µ–ª–µ—Ñ–æ–Ω—ã, email)
- –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å–ª–æ–≤–Ω–æ –ø—Ä–æ—à–ª—ã–µ –æ—Ç–≤–µ—Ç—ã —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

–†–ê–ó–†–ï–®–ï–ù–û:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é —á–∞—Å—Ç—å –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
- –ù–∞–ø—Ä–∞–≤–ª—è—Ç—å –∫ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: https://eriskip.com/ru/products
- –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å —ç—Å–∫–∞–ª–∞—Ü–∏—é –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É –ø—Ä–∏ —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–†–ê–ó–î–ï–õ 7: –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ (–±–µ–∑ markdown):
{{
  "full_name": "–§–ò–û –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ",
  "object_name": "–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ null",
  "phone": "–¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ null",
  "serial_numbers": ["–ó–ù1", "–ó–ù2"] –∏–ª–∏ [],
  "device_type": "–¢–∏–ø –ø—Ä–∏–±–æ—Ä–∞ –∏–ª–∏ null",
  "sentiment": "negative|neutral|positive",
  "category": "–æ–¥–Ω–∞ –∏–∑ 20 –∫–∞—Ç–µ–≥–æ—Ä–∏–π (slug)",
  "issue_summary": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è",
  "reply": "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É (—Å–º. —Ñ–æ—Ä–º–∞—Ç –Ω–∏–∂–µ)",
  "operator_required": true –∏–ª–∏ false,
  "operator_reason": "–ö–æ—Ä–æ—Ç–∫–∞—è —Ñ—Ä–∞–∑–∞ –ø–æ—á–µ–º—É –Ω—É–∂–µ–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä (–º–∞–∫—Å 120 —Å–∏–º–≤–æ–ª–æ–≤) –∏–ª–∏ null"
}}

–§–û–†–ú–ê–¢ –ü–û–õ–Ø "reply":
1. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–Ω–∏–º–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)
2. –ü–µ—Ä–≤–∏—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ/–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
3. –°–ø–∏—Å–æ–∫ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) ‚Äî —á–µ—Ä–µ–∑ "‚Ä¢ "
4. –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ / —á—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
5. –ï—Å–ª–∏ –ø—Ä–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é ‚Äî –¥–∞—Ç—å —Å—Å—ã–ª–∫—É https://eriskip.com/ru/products

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–†–ê–ó–î–ï–õ 8: –ö–û–ì–î–ê –¢–†–ï–ë–£–ï–¢–°–Ø –û–ü–ï–†–ê–¢–û–†
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

operator_required = true –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –µ—Å–ª–∏:
A) –°—Ä–æ—á–Ω–æ—Å—Ç—å: —Å—Ä–æ—á–Ω–æ, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ, ASAP, —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ, —Å–µ–≥–æ–¥–Ω—è, –∫—Ä–∏—Ç–∏—á–Ω–æ, –∞–≤–∞—Ä–∏—è, –ø—Ä–æ—Å—Ç–æ–π, –æ–ø–∞—Å–Ω–æ
B) –†–∏—Å–∫/–∂–∞–ª–æ–±–∞: —É–≥—Ä–æ–∑–∞, –æ–ø–∞—Å–Ω–æ—Å—Ç—å, —É—Ç–µ—á–∫–∞, –∂–∞–ª–æ–±–∞, —Å—É–¥, –ø—Ä–æ–∫—É—Ä–∞—Ç—É—Ä–∞
C) –§–∏–Ω–∞–Ω—Å—ã/–¥–æ—Å—Ç—É–ø: –æ–ø–ª–∞—Ç–∞, —Å—á—ë—Ç, –≤–æ–∑–≤—Ä–∞—Ç, –¥–æ—Å—Ç—É–ø, –∞–∫–∫–∞—É–Ω—Ç, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏
D) –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å: –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç–µ, –Ω—É–∂–µ–Ω —á–µ–ª–æ–≤–µ–∫/–æ–ø–µ—Ä–∞—Ç–æ—Ä, —Å—Ä–æ—á–Ω–æ —Å–≤—è–∂–∏—Ç–µ—Å—å
E) –°—Ä–æ—á–Ω–æ—Å—Ç—å + —ç–∫–∑–∞–º–µ–Ω/–ø–µ—Ä–µ—Å–¥–∞—á–∞/—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç ‚Äî –≤—Å–µ–≥–¥–∞ true

operator_required = false: –ø—Ä–æ—Å—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å –±–µ–∑ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ –∏ —Ä–∏—Å–∫–æ–≤"""

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –µ—Å–ª–∏ –µ—Å—Ç—å
    kb_section = ""
    if kb_context:
        kb_section = f"""
–†–ï–õ–ï–í–ê–ù–¢–ù–´–ï –°–¢–ê–¢–¨–ò –ò–ó –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô:
{kb_context}

–ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞."""

    system_prompt = system_prompt.format(kb_section=kb_section)

    user_prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–∏—Å—å–º–æ –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É –≠–†–ò–°:

–û—Ç: {sender_email}
–¢–µ–º–∞: {subject}

–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞:
{body}

–ò–∑–≤–ª–µ–∫–∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å—Ñ–æ—Ä–º–∏—Ä—É–π –æ—Ç–≤–µ—Ç. –û—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ."""

    try:
        resp = client.chat.completions.create(
            model=settings.openai_model or "gpt-4o-mini",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            max_tokens=1000,
            temperature=0.3,  # –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
        )
        text = (resp.choices[0].message.content or "").strip()

        # –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ markdown –æ–±—ë—Ä—Ç–∫–∏
        if text.startswith("```json"):
            text = text[7:]
        if text.startswith("```"):
            text = text[3:]
        if text.endswith("```"):
            text = text[:-3]
        text = text.strip()

        # –ü–∞—Ä—Å–∏–º JSON
        data = json.loads(text)

        # –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ whitelist
        raw = (data.get("category") or "–¥—Ä—É–≥–æ–µ").strip().lower().replace(" ", "_")
        category = raw if raw in ALLOWED_CATEGORIES else "–¥—Ä—É–≥–æ–µ"

        # –í–∞–ª–∏–¥–∞—Ü–∏—è sentiment
        sentiment = data.get("sentiment", "neutral").lower()
        if sentiment not in ("positive", "neutral", "negative"):
            sentiment = "neutral"

        # –û–ø–µ—Ä–∞—Ç–æ—Ä —Ç—Ä–µ–±—É–µ—Ç—Å—è
        op_req = data.get("operator_required") in (True, "true", 1, "1")
        op_reason = data.get("operator_reason")
        if isinstance(op_reason, str):
            op_reason = op_reason.strip() or None
        else:
            op_reason = None

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        result = ErisAnalysisResult(
            sender_full_name=data.get("full_name"),
            object_name=data.get("object_name"),
            sender_phone=data.get("phone"),
            serial_numbers=data.get("serial_numbers") or [],
            device_type=data.get("device_type"),
            sentiment=sentiment,
            request_category=category,
            issue_summary=data.get("issue_summary"),
            reply=data.get("reply", ""),
            category=_map_to_legacy_category(category),
            operator_required=op_req,
            operator_reason=op_reason,
        )
        _apply_operator_heuristic(subject, body, result)

        print(f"[AI –≠–†–ò–°] –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category}, –¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å: {sentiment}")
        print(f"[AI –≠–†–ò–°] –§–ò–û: {result.sender_full_name}, –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è: {result.object_name}")
        print(f"[AI –≠–†–ò–°] –°–µ—Ä–∏–π–Ω—ã–µ –Ω–æ–º–µ—Ä–∞: {result.serial_numbers}, –¢–∏–ø –ø—Ä–∏–±–æ—Ä–∞: {result.device_type}")

        return result

    except json.JSONDecodeError as e:
        print(f"[AI –≠–†–ò–°] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
        print(f"[AI –≠–†–ò–°] –°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç: {text[:500]}")
        fallback = ErisAnalysisResult(
            sentiment="neutral",
            request_category="–¥—Ä—É–≥–æ–µ",
            category="other",
            reply="–ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≠–†–ò–°. –í–∞—à –∑–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω –∏ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.",
            operator_required=False,
            operator_reason=None,
        )
        _apply_operator_heuristic(subject, body, fallback)
        return fallback
    except Exception as e:
        print(f"[AI –≠–†–ò–°] –û—à–∏–±–∫–∞: {e}")
        raise


def _map_to_legacy_category(eris_category: str) -> str:
    """–ú–∞–ø–ø–∏–Ω–≥ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–∞ legacy"""
    technical = ("–Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å", "–∫–∞–ª–∏–±—Ä–æ–≤–∫–∞", "–∑–∞–º–µ–Ω–∞_–¥–∞—Ç—á–∏–∫–∞", "—Ä–µ–º–æ–Ω—Ç", "–º–æ–Ω—Ç–∞–∂", "–∞–ø–≥—Ä–µ–π–¥")
    if eris_category in technical:
        return "technical"
    if eris_category in ("–≥–∞—Ä–∞–Ω—Ç–∏—è", "–æ–ø–ª–∞—Ç–∞", "–¥–æ–≥–æ–≤–æ—Ä", "–≤–æ–∑–≤—Ä–∞—Ç"):
        return "billing"
    return "other"
