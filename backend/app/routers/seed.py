"""
Seed данных для демонстрации и кейса ЭРИС.
"""
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from app.db import get_db
from app.auth import require_admin_dep
from app.models import Category, Ticket, KbArticle

router = APIRouter(prefix="/api", tags=["seed"])

# Категории для кейса ЭРИС
ERIS_CATEGORIES = [
    {"name": "неисправность", "description": "Прибор не работает, выдаёт ошибки, неверные показания"},
    {"name": "калибровка", "description": "Запрос на калибровку, поверку, настройку приборов"},
    {"name": "запрос_документации", "description": "Паспорт, сертификат, руководство, методика поверки"},
    {"name": "гарантия", "description": "Гарантийные вопросы, гарантийный ремонт, замена по гарантии"},
    {"name": "замена_датчика", "description": "Замена чувствительного элемента, сенсора"},
    {"name": "консультация", "description": "Вопросы по эксплуатации, выбору оборудования"},
    {"name": "другое", "description": "Прочие запросы"},
    # Legacy категории для совместимости
    {"name": "billing", "description": "Платежи и подписки"},
    {"name": "technical", "description": "Технические проблемы"},
    {"name": "access", "description": "Доступ и аккаунт"},
    {"name": "other", "description": "Прочее"},
]

# База знаний ЭРИС - статьи для AI контекста
ERIS_KB_ARTICLES = [
    {
        "title": "Калибровка газоанализаторов ЭРИС-210 и ЭРИС-230",
        "content": """Калибровка газоанализаторов серии ЭРИС проводится с использованием поверочных газовых смесей (ПГС).

ПОРЯДОК КАЛИБРОВКИ:
1. Подготовьте ПГС соответствующего состава (согласно руководству по эксплуатации)
2. Подключите редуктор к баллону с ПГС
3. Войдите в меню калибровки (удерживайте кнопку МЕНЮ 3 секунды)
4. Выберите «Калибровка нуля» — подайте чистый воздух
5. Выберите «Калибровка диапазона» — подайте ПГС
6. Дождитесь стабилизации показаний (не менее 60 сек)
7. Подтвердите калибровку

ПЕРИОДИЧНОСТЬ:
- Поверка: 1 раз в год (для внесённых в Госреестр СИ)
- Калибровка: по необходимости или согласно регламенту предприятия

При возникновении ошибок калибровки обратитесь в сервисный центр ЭРИС.""",
        "tags": "калибровка,поверка,ЭРИС-210,ЭРИС-230,ПГС,настройка"
    },
    {
        "title": "Замена датчика (чувствительного элемента) в газоанализаторах ЭРИС",
        "content": """Датчики газоанализаторов ЭРИС имеют ограниченный срок службы и требуют периодической замены.

ПРИЗНАКИ НЕОБХОДИМОСТИ ЗАМЕНЫ:
- Невозможность калибровки (показания не стабилизируются)
- Систематическое занижение/завышение показаний
- Истёк срок службы датчика (указан в паспорте)
- Сообщение «Ошибка датчика» на дисплее

СРОК СЛУЖБЫ ДАТЧИКОВ:
- Электрохимические (CO, H2S, O2): 2-3 года
- Инфракрасные (CH4, CO2): 5-7 лет
- Термокаталитические (горючие газы): 2-4 года

ЗАМЕНА ДАТЧИКА:
Замена производится в авторизованном сервисном центре ЭРИС.
Самостоятельная замена может привести к потере гарантии.

Для заказа датчика укажите:
- Модель газоанализатора
- Заводской номер прибора
- Определяемый газ и диапазон измерений""",
        "tags": "датчик,замена,сенсор,чувствительный элемент,срок службы"
    },
    {
        "title": "Ошибки газоанализаторов ЭРИС и способы их устранения",
        "content": """ТИПИЧНЫЕ ОШИБКИ И РЕШЕНИЯ:

E01 — Ошибка датчика
- Проверьте подключение датчика
- Выполните калибровку нуля
- При повторении — замените датчик

E02 — Ошибка памяти
- Выключите прибор на 10 минут
- При повторении — обратитесь в сервис

E03 — Низкое напряжение батареи
- Зарядите встроенный аккумулятор
- Для приборов с батарейками — замените элементы питания

E04 — Превышение диапазона
- Переместите прибор в незагазованную зону
- Дождитесь продувки датчика (5-10 минут)

E05 — Ошибка связи
- Проверьте кабель подключения
- Проверьте настройки интерфейса (RS-485, 4-20мА)

ОБЩИЕ РЕКОМЕНДАЦИИ:
- Не используйте прибор при температуре ниже/выше указанной в паспорте
- Регулярно проводите техническое обслуживание
- При повторяющихся ошибках обратитесь в сервисный центр""",
        "tags": "ошибка,неисправность,E01,E02,E03,E04,E05,устранение"
    },
    {
        "title": "Документация на газоанализаторы ЭРИС",
        "content": """ДОСТУПНАЯ ДОКУМЕНТАЦИЯ:

1. ПАСПОРТ И РУКОВОДСТВО ПО ЭКСПЛУАТАЦИИ
- Содержит технические характеристики, инструкции по эксплуатации
- Выдаётся при покупке прибора
- Дубликат можно заказать в сервисном центре

2. СВИДЕТЕЛЬСТВО О ПОВЕРКЕ
- Подтверждает соответствие прибора метрологическим требованиям
- Срок действия: 1 год
- Получить можно в аккредитованном центре поверки

3. СЕРТИФИКАТ СООТВЕТСТВИЯ
- TR CU 012/2011 (взрывозащита)
- TR CU 020/2011 (электромагнитная совместимость)
- Копии доступны на сайте ЭРИС

4. ДЕКЛАРАЦИЯ О СООТВЕТСТВИИ
- Подтверждает безопасность продукции
- Номер указан на шильдике прибора

5. МЕТОДИКА ПОВЕРКИ
- МП 242-2019-2020 для газоанализаторов ЭРИС
- Доступна в ФГИС «Аршин»

Для получения документов:
- Email: docs@eris.ru
- Телефон: 8 (800) 555-35-35""",
        "tags": "документация,паспорт,сертификат,руководство,свидетельство,поверка"
    },
    {
        "title": "Гарантийное обслуживание газоанализаторов ЭРИС",
        "content": """УСЛОВИЯ ГАРАНТИИ:

ГАРАНТИЙНЫЙ СРОК:
- Газоанализаторы: 24 месяца с даты продажи
- Датчики электрохимические: 12 месяцев
- Датчики инфракрасные: 36 месяцев

ГАРАНТИЯ РАСПРОСТРАНЯЕТСЯ НА:
- Производственные дефекты
- Выход из строя электронных компонентов
- Дефекты корпуса и конструкции

ГАРАНТИЯ НЕ РАСПРОСТРАНЯЕТСЯ НА:
- Механические повреждения
- Повреждения из-за неправильной эксплуатации
- Естественный износ датчиков
- Последствия самостоятельного ремонта
- Повреждения из-за воздействия агрессивных сред

ДЛЯ ГАРАНТИЙНОГО ОБРАЩЕНИЯ:
1. Заполните заявку на сайте или позвоните
2. Укажите заводской номер прибора
3. Опишите неисправность
4. Приложите копию паспорта с отметкой о продаже

Срок рассмотрения заявки: до 5 рабочих дней
Срок гарантийного ремонта: до 30 рабочих дней""",
        "tags": "гарантия,ремонт,обслуживание,срок,условия"
    },
    {
        "title": "Техническое обслуживание газоанализаторов ЭРИС",
        "content": """РЕГЛАМЕНТ ТЕХНИЧЕСКОГО ОБСЛУЖИВАНИЯ:

ЕЖЕДНЕВНО:
- Визуальный осмотр прибора
- Проверка работоспособности (включение/выключение)
- Проверка уровня заряда батареи

ЕЖЕНЕДЕЛЬНО:
- Очистка корпуса от загрязнений
- Проверка целостности кабелей
- Тестовая проверка срабатывания (при наличии тест-газа)

ЕЖЕМЕСЯЧНО:
- Проверка нуля прибора на чистом воздухе
- Проверка герметичности соединений
- Очистка защитных фильтров датчика

ЕЖЕГОДНО (обязательно):
- Периодическая поверка в аккредитованном центре
- Калибровка по ПГС
- Замена расходных материалов (фильтры, прокладки)

РЕКОМЕНДУЕМЫЕ РАСХОДНЫЕ МАТЕРИАЛЫ:
- Фильтры защитные: замена каждые 3-6 месяцев
- Уплотнители: замена при износе
- Батареи/аккумуляторы: по мере износа

Сервисные центры ЭРИС расположены в 15 городах России.""",
        "tags": "обслуживание,ТО,техническое,регламент,проверка"
    },
    {
        "title": "Подключение газоанализаторов ЭРИС к системам АСУ ТП",
        "content": """ИНТЕРФЕЙСЫ ПОДКЛЮЧЕНИЯ:

1. АНАЛОГОВЫЙ ВЫХОД 4-20 мА
- Стандартный токовый сигнал
- Пропорционален концентрации газа
- 4 мА = 0%, 20 мА = 100% диапазона
- Сопротивление нагрузки: до 500 Ом

2. RS-485 (MODBUS RTU)
- Двухпроводный интерфейс
- Скорость: 9600, 19200, 38400 бод
- Адрес: 1-247 (настраивается)
- Регистры: см. руководство по эксплуатации

3. HART-ПРОТОКОЛ (опция)
- Совместимость с AMS/PDM системами
- Настройка и диагностика удалённо

ТИПОВЫЕ СХЕМЫ ПОДКЛЮЧЕНИЯ:
- Искробезопасная цепь (Ex ia)
- Взрывозащищённое подключение (Ex d)
- Стандартное подключение (общепромышленное)

ВАЖНО:
- Соблюдайте полярность подключения
- Используйте экранированный кабель
- Заземляйте экран с одной стороны
- Максимальная длина линии RS-485: 1200 м

При необходимости интеграции обратитесь в техподдержку.""",
        "tags": "подключение,АСУ,MODBUS,RS-485,4-20мА,интерфейс"
    },
    {
        "title": "Газоанализаторы ЭРИС-210: технические характеристики",
        "content": """ГАЗОАНАЛИЗАТОР ЭРИС-210 — СТАЦИОНАРНЫЙ ДАТЧИК-ГАЗОАНАЛИЗАТОР

НАЗНАЧЕНИЕ:
Непрерывный автоматический контроль концентрации горючих и токсичных газов.

ИЗМЕРЯЕМЫЕ ГАЗЫ:
- Метан (CH4): 0-100% НКПР
- Пропан (C3H8): 0-100% НКПР
- Угарный газ (CO): 0-500 ppm
- Сероводород (H2S): 0-100 ppm
- Кислород (O2): 0-25% об.
- Другие газы по заказу

ТЕХНИЧЕСКИЕ ХАРАКТЕРИСТИКИ:
- Диапазон рабочих температур: -60...+85°C
- Степень защиты: IP66/IP67
- Взрывозащита: 1Ex d IIC T6 Gb
- Выходной сигнал: 4-20 мА, RS-485
- Напряжение питания: 18-36 В DC
- Потребляемая мощность: до 4 Вт
- Время отклика T90: до 30 сек

КОМПЛЕКТАЦИЯ:
- Датчик-газоанализатор
- Монтажный комплект
- Паспорт, РЭ
- Свидетельство о первичной поверке""",
        "tags": "ЭРИС-210,характеристики,стационарный,технические,газоанализатор"
    },
    {
        "title": "Газоанализаторы ЭРИС-230: технические характеристики",
        "content": """ГАЗОАНАЛИЗАТОР ЭРИС-230 — МНОГОКАНАЛЬНЫЙ СТАЦИОНАРНЫЙ ГАЗОАНАЛИЗАТОР

НАЗНАЧЕНИЕ:
Контроль до 4 газов одновременно в одном корпусе.

ПРЕИМУЩЕСТВА:
- Компактное решение для комплексного мониторинга
- Единое питание и выход
- Экономия на монтаже

ИЗМЕРЯЕМЫЕ ГАЗЫ (до 4 каналов):
- Горючие газы (CH4, C3H8, H2)
- Токсичные газы (CO, H2S, NO2, Cl2, NH3)
- Кислород (O2)

ТЕХНИЧЕСКИЕ ХАРАКТЕРИСТИКИ:
- Количество каналов: 1-4
- Диапазон температур: -40...+60°C
- Степень защиты: IP65
- Взрывозащита: 1Ex d IIC T6 Gb
- Выходной сигнал: 4-20 мА (на каждый канал), RS-485
- Питание: 24 В DC
- Потребление: до 10 Вт

ОБЛАСТИ ПРИМЕНЕНИЯ:
- Нефтегазовая промышленность
- Химические производства
- Котельные и ТЭЦ
- Подземные сооружения""",
        "tags": "ЭРИС-230,характеристики,многоканальный,стационарный"
    },
    {
        "title": "Датчики ДГС-ЭРИС: описание и характеристики",
        "content": """ДАТЧИКИ ГАЗОВЫЕ СИГНАЛИЗАТОРЫ ДГС-ЭРИС

СЕРИЯ ВКЛЮЧАЕТ:
- ДГС-ЭРИС-М — на метан и горючие газы
- ДГС-ЭРИС-С — на токсичные газы
- ДГС-ЭРИС-О — на кислород

ПРИНЦИП ДЕЙСТВИЯ:
- Электрохимический (токсичные газы, O2)
- Термокаталитический (горючие газы)
- Инфракрасный (CO2, CH4)

ОСОБЕННОСТИ:
- Малые габариты
- Простой монтаж
- Низкое энергопотребление
- Длительный срок службы

ТИПОРАЗМЕРЫ:
- ДГС-ЭРИС-110: компактный, для ограниченных пространств
- ДГС-ЭРИС-210: стандартный, универсальный
- ДГС-ЭРИС-310: усиленный, для сложных условий

ВЗАИМОЗАМЕНЯЕМОСТЬ:
Датчики ДГС-ЭРИС совместимы с большинством систем газового контроля.

ПЕРИОДИЧНОСТЬ ЗАМЕНЫ:
- Электрохимические: 2-3 года
- Термокаталитические: 3-4 года
- Инфракрасные: 5-7 лет""",
        "tags": "ДГС-ЭРИС,датчик,сигнализатор,характеристики"
    },
    {
        "title": "Контакты службы технической поддержки ЭРИС",
        "content": """СЛУЖБА ТЕХНИЧЕСКОЙ ПОДДЕРЖКИ ЭРИС

ТЕЛЕФОН ГОРЯЧЕЙ ЛИНИИ:
8 (800) 555-35-35 (бесплатно по России)

РЕЖИМ РАБОТЫ:
Пн-Пт: 8:00 — 18:00 (МСК)
Сб-Вс: выходной

EMAIL:
- Общие вопросы: info@eris.ru
- Техподдержка: support@eris.ru
- Документация: docs@eris.ru
- Сервис и ремонт: service@eris.ru

СЕРВИСНЫЕ ЦЕНТРЫ:
- Москва: ул. Промышленная, 10
- Санкт-Петербург: пр. Обуховской обороны, 120
- Екатеринбург: ул. Машиностроителей, 19
- Казань: ул. Техническая, 27
- Новосибирск: ул. Станционная, 60
(Полный список на сайте)

ОНЛАЙН:
- Сайт: www.eris.ru
- Личный кабинет: lk.eris.ru
- Форма обратной связи на сайте

ПРИ ОБРАЩЕНИИ УКАЖИТЕ:
1. Наименование организации
2. Контактное лицо и телефон
3. Модель и заводской номер прибора
4. Описание проблемы или вопроса""",
        "tags": "контакты,поддержка,сервис,телефон,email"
    },
    {
        "title": "Часто задаваемые вопросы (FAQ) по газоанализаторам ЭРИС",
        "content": """ЧАСТО ЗАДАВАЕМЫЕ ВОПРОСЫ:

В: Как часто нужно делать поверку?
О: Межповерочный интервал — 1 год. Поверка проводится в аккредитованных центрах.

В: Можно ли самостоятельно заменить датчик?
О: Не рекомендуется. Замена должна производиться в сервисном центре с последующей калибровкой.

В: Прибор показывает «Ошибка датчика». Что делать?
О: Выполните калибровку нуля. Если ошибка повторяется — требуется замена датчика.

В: Как долго служит датчик?
О: Зависит от типа: электрохимические 2-3 года, инфракрасные 5-7 лет.

В: Можно ли использовать прибор на морозе?
О: Да, ЭРИС-210 работает до -60°C, ЭРИС-230 до -40°C.

В: Как получить дубликат паспорта?
О: Обратитесь в сервисный центр с указанием заводского номера.

В: Сколько стоит ремонт?
О: Стоимость зависит от характера неисправности. Диагностика бесплатная.

В: Есть ли выездное обслуживание?
О: Да, инженеры ЭРИС выезжают на объекты по всей России.""",
        "tags": "FAQ,вопросы,ответы,частые"
    },
]

# Демо-тикеты для кейса ЭРИС
ERIS_DEMO_TICKETS = [
    {
        "sender_email": "ivanov@neftegaz.ru",
        "sender_name": "Иванов И.И.",
        "subject": "Ошибка датчика на ЭРИС-210",
        "body": """Добрый день!

На нашем объекте (Нефтеперерабатывающий завод, г. Уфа) установлен газоанализатор ЭРИС-210, ЗН: 2024-0547.
Прибор стал показывать ошибку E01 "Ошибка датчика".

Калибровка нуля не помогает, ошибка появляется снова через несколько часов.
Прибор на гарантии, куплен 6 месяцев назад.

Прошу сообщить, что делать в данной ситуации.

С уважением,
Иванов Иван Иванович
Главный инженер
Тел: +7 (917) 123-45-67""",
        "priority": "high",
        "request_category": "неисправность",
        "sentiment": "negative"
    },
    {
        "sender_email": "petrova@gazprom.ru",
        "sender_name": "Петрова А.С.",
        "subject": "Запрос на калибровку газоанализаторов",
        "body": """Здравствуйте!

Просим провести калибровку 5 газоанализаторов ЭРИС-230 на нашем объекте.
Заводские номера: 2023-1001, 2023-1002, 2023-1003, 2023-1004, 2023-1005.

Объект: Компрессорная станция "Северная", Ямало-Ненецкий АО.
Предпочтительные даты: следующая неделя.

Контактное лицо: Петрова Анна Сергеевна
Телефон: 8-912-555-00-00

Заранее благодарю за ответ.

С уважением,
Петрова А.С.""",
        "priority": "medium",
        "request_category": "калибровка",
        "sentiment": "neutral"
    },
    {
        "sender_email": "sidorov@metrology.ru",
        "sender_name": "Сидоров П.В.",
        "subject": "Нужна методика поверки МП 242-2019",
        "body": """Добрый день!

Мы аккредитованная метрологическая лаборатория. Для проведения поверки газоанализаторов ЭРИС-210 нам необходима методика поверки МП 242-2019-2020.

На сайте ФГИС "Аршин" документ не скачивается.

Просим выслать методику в электронном виде.

Благодарю,
Сидоров Павел""",
        "priority": "low",
        "request_category": "запрос_документации",
        "sentiment": "neutral"
    },
]


@router.post("/seed-demo")
def seed_demo(db: Session = Depends(get_db), _admin: bool = Depends(require_admin_dep)):
    """Добавляет демонстрационные данные (категории, KB статьи, тикеты)."""
    created_categories = 0
    created_articles = 0
    created_tickets = 0

    # 1. Создаём категории ЭРИС
    for c in ERIS_CATEGORIES:
        existing = db.query(Category).filter(Category.name == c["name"]).first()
        if not existing:
            db.add(Category(name=c["name"], description=c.get("description")))
            created_categories += 1
    db.commit()

    # 2. Наполняем базу знаний
    for article in ERIS_KB_ARTICLES:
        existing = db.query(KbArticle).filter(KbArticle.title == article["title"]).first()
        if not existing:
            db.add(KbArticle(
                title=article["title"],
                content=article["content"],
                tags=article.get("tags", "")
            ))
            created_articles += 1
    db.commit()

    # 3. Создаём демо-тикеты ЭРИС
    for t in ERIS_DEMO_TICKETS:
        ticket = Ticket(
            sender_email=t["sender_email"],
            sender_name=t.get("sender_name"),
            subject=t["subject"],
            body=t["body"],
            status="new",
            priority=t["priority"],
            source="email",
            request_category=t.get("request_category"),
            sentiment=t.get("sentiment"),
        )
        db.add(ticket)
        created_tickets += 1
    db.commit()

    return {
        "message": "ЭРИС demo data seeded",
        "categories_created": created_categories,
        "kb_articles_created": created_articles,
        "tickets_created": created_tickets
    }


@router.post("/seed-kb")
def seed_kb_only(db: Session = Depends(get_db), _admin: bool = Depends(require_admin_dep)):
    """Добавляет только статьи базы знаний ЭРИС."""
    created = 0
    for article in ERIS_KB_ARTICLES:
        existing = db.query(KbArticle).filter(KbArticle.title == article["title"]).first()
        if not existing:
            db.add(KbArticle(
                title=article["title"],
                content=article["content"],
                tags=article.get("tags", "")
            ))
            created += 1
    db.commit()
    return {"message": f"Created {created} KB articles", "total": len(ERIS_KB_ARTICLES)}


@router.post("/seed-categories")
def seed_categories_only(db: Session = Depends(get_db), _admin: bool = Depends(require_admin_dep)):
    """Добавляет только категории ЭРИС."""
    created = 0
    for c in ERIS_CATEGORIES:
        existing = db.query(Category).filter(Category.name == c["name"]).first()
        if not existing:
            db.add(Category(name=c["name"], description=c.get("description")))
            created += 1
    db.commit()
    return {"message": f"Created {created} categories", "total": len(ERIS_CATEGORIES)}
