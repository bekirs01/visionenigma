# VisionEnigma Support MVP

Система технической поддержки с веб-интерфейсом, панелью оператора и автоматическим анализом обращений с помощью ИИ. Интерфейс на русском языке.

---

## 1. О проекте

**VisionEnigma Support MVP** — это прототип сервиса обработки обращений в техподдержку. Пользователи создают обращения (тикеты) через веб-форму; оператор просматривает их в админ-панели. При создании тикета запускается анализ текста (категория, тон, необходимость оператора, подсказка ответа); при наличии ключа OpenAI используется реальная модель, иначе — шаблонные ответы.

### Основные возможности

- **Пользовательский портал** — форма создания обращения, список «Мои обращения» (по устройству/токену), просмотр деталей своего тикета без доступа к ответам ИИ и админ-инструментам.
- **Админ-панель** — список всех тикетов, фильтры (поиск, статус, категория), детальная страница с ответом ИИ, меткой «Требуется оператор», экспорт в CSV. Вход по коду доступа.
- **ИИ-анализ** — извлечение ФИО, организации, телефона, категории запроса (из фиксированного списка), тональности, признака «требуется оператор» и черновика ответа. Опционально — извлечение модели прибора из текста (regex + ИИ).
- **Демо-данные** — кнопка «Seed демо» в админке создаёт набор тикетов с полным прохождением того же ИИ-пайплайна.
- **Почта** — в текущей версии в режиме mock (реальный IMAP/SMTP не обязателен; интерфейсы подготовлены для будущего подключения).

---

## 2. Структура проекта

```
visionenigma/
├── backend/                 # Backend (FastAPI)
│   ├── app/
│   │   ├── main.py         # Точка входа, CORS, роутеры
│   │   ├── config.py       # Настройки из .env
│   │   ├── db.py           # Подключение к БД, миграции при старте
│   │   ├── models/         # SQLAlchemy-модели (Ticket, Category и др.)
│   │   ├── schemas/        # Pydantic-схемы для API
│   │   ├── routers/        # Эндпоинты: tickets, categories, seed, admin, ai
│   │   ├── services/       # AI-агент, OpenAI, извлечение прибора, почтовые заглушки
│   │   └── auth.py         # Проверка кода доступа админа
│   ├── alembic/            # Миграции БД
│   ├── requirements.txt
│   ├── Dockerfile
│   └── .env.example        # ADMIN_ACCESS_CODE, OPENAI_API_KEY и др.
├── frontend/               # Frontend (Next.js, React, TypeScript, Tailwind)
│   ├── app/
│   │   ├── page.tsx        # Главная: выбор роли (Пользователь / Админ)
│   │   ├── user/           # Форма обращения, «Мои обращения», детали тикета
│   │   ├── admin/          # Вход в админку, панель списка и детали тикета
│   │   ├── tickets/        # Деталь тикета (админ)
│   │   └── i18n/           # Локализация (по умолчанию RU)
│   ├── components/
│   ├── lib/api.ts          # Клиент API
│   ├── package.json
│   ├── Dockerfile
│   └── .env.example        # NEXT_PUBLIC_API_BASE_URL
├── .env.example            # Корневой шаблон: БД, OpenAI, порты, почта (mock)
├── Makefile                # dev-backend, dev-frontend, docker up/down, seed
├── setup.sh                # Первичная настройка (Linux/macOS)
├── setup.bat               # Первичная настройка (Windows)
└── docker-compose.yml      # db (Postgres), backend, frontend
```

- **Backend** — FastAPI, SQLAlchemy, Alembic, при необходимости OpenAI. Запуск: `uvicorn app.main:app`.
- **Frontend** — Next.js 14 (App Router), сборка через **npm** (в проекте используется `package-lock.json`, скрипты в `package.json`: `dev`, `build`, `start`).
- Конфигурация берётся из корневого `.env` и при необходимости переопределяется в `backend/.env`.

---

## 3. Требования

- **Python** — 3.11 (указано в `backend/Dockerfile`; для локального запуска желательна совместимая версия).
- **Node.js** — 20 (указано в `frontend/Dockerfile`; для локального запуска подойдёт LTS).
- **База данных** — PostgreSQL (например 15). При локальном запуске без Docker можно использовать `USE_SQLITE=1` и SQLite (файл в каталоге backend).
- **Docker и Docker Compose** — только если запуск планируется через контейнеры.

---

## 4. Установка и запуск

Команды ниже соответствуют скриптам и целям Makefile в репозитории.

### 4.1. Первичная настройка

Перед первым запуском удобно один раз выполнить скрипт установки: он создаёт `.env` из примера (если файла ещё нет) и ставит зависимости backend и frontend.

**macOS / Linux:**

```bash
cd visionenigma
chmod +x setup.sh
./setup.sh
```

Скрипт копирует `.env.example` в `.env` в корне проекта и выводит напоминание про настройку `OPENAI_API_KEY` и запуск в двух терминалах.

**Windows (CMD):**

```bash
cd visionenigma
setup.bat
```

Скрипт делает то же самое: при отсутствии `.env` копирует `.env.example`, устанавливает зависимости backend и frontend и подсказывает команды запуска.

### 4.2. Запуск без Docker (два терминала)

Обычно backend и frontend запускают отдельно. В репозитории для этого предусмотрены цели Makefile.

**Терминал 1 — backend:**

```bash
cd visionenigma
make dev-backend
```

Этой командой в каталоге `backend` устанавливаются зависимости (`pip install -r requirements.txt`), выполняются миграции Alembic (`alembic upgrade head`) и запускается сервер:

```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

Если вы не используете Make, можно выполнить вручную:

```bash
cd visionenigma/backend
pip install -r requirements.txt
alembic upgrade head
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

(На Windows вместо `make dev-backend` — те же три команды по очереди в `backend`.)

**Терминал 2 — frontend:**

```bash
cd visionenigma
make dev-frontend
```

В каталоге `frontend` выполняется `npm install` и `npm run dev`. Вручную:

```bash
cd visionenigma/frontend
npm install
npm run dev
```

После запуска:

- Frontend: **http://localhost:3000**
- Backend API: **http://localhost:8000**
- Документация API: **http://localhost:8000/docs**

### 4.3. Запуск через Docker Compose

Если нужна полная среда с PostgreSQL в контейнере:

1. В корне проекта создать `.env` (например из `.env.example`).
2. Запустить сервисы:

```bash
cd visionenigma
docker-compose up -d
```

В `docker-compose.yml` описаны сервисы: `db` (Postgres 15), `backend` (сборка из `backend/Dockerfile`, при старте — миграции и uvicorn), `frontend` (сборка из `frontend/Dockerfile`, `npm run dev`). Backend читает `DATABASE_URL` вида `postgresql://postgres:postgres@db:5432/support_mvp`.

После поднятия контейнеров адреса те же: frontend — 3000, backend — 8000. Демо-данные можно загрузить так:

```bash
make seed
```

или:

```bash
curl -X POST http://localhost:8000/api/seed-demo
```

(Эндпоинт seed в коде защищён проверкой админ-доступа.)

### 4.4. Windows: альтернатива без Make

На Windows, если `make` не установлен, можно ориентироваться на то, что делает `setup.bat`:

- Backend: `cd backend` → `pip install -r requirements.txt` → `alembic upgrade head` → `python -m uvicorn app.main:app --reload --port 8000`.
- Frontend: `cd frontend` → `npm install` → `npm run dev`.

Корневой `.env` (или `backend/.env`) должен быть настроен так же, как в разделе про переменные окружения ниже.

---

## 5. Переменные окружения (.env)

В репозитории есть три примера конфигурации:

- **Корневой `.env.example`** — основной шаблон для запуска (в т.ч. Docker): приложение, БД, фронт, почта, ИИ.
- **`backend/.env.example`** — код входа в админку и опционально OpenAI/SMTP.
- **`frontend/.env.example`** — базовый URL API для фронтенда.

Backend загружает переменные сначала из корневого `.env`, затем из `backend/.env` (значения из `backend/.env` имеют приоритет). Имеет смысл не коммитить реальные ключи и пароли: в репозитории лежат только примеры без секретов; локально каждый копирует пример в `.env` и подставляет свои значения.

Основные переменные:

| Переменная | Описание |
|------------|----------|
| `DATABASE_URL` | URL подключения к PostgreSQL (при Docker — обычно `postgresql://postgres:postgres@db:5432/support_mvp`). |
| `USE_SQLITE` | Если задано `1`, используется SQLite вместо PostgreSQL (удобно для локальной разработки без Docker). |
| `OPENAI_API_KEY` | Ключ OpenAI для ИИ-анализа. Без ключа используются шаблонные ответы. |
| `ADMIN_ACCESS_CODE` | Код входа в админ-панель (в `backend/.env.example` указан пример). |
| `NEXT_PUBLIC_API_BASE_URL` | URL бэкенда для фронтенда (например `http://localhost:8000`). |

**Входящая почта (IMAP) и синхронизация**

- Чтобы письма из Gmail (или другого ящика) попадали в таблицу обращений, задайте в `backend/.env`: `IMAP_HOST=imap.gmail.com`, `IMAP_PORT=993`, `IMAP_USER`, `IMAP_PASS` (тот же App Password, что и для SMTP).
- В админ-панели кнопка **«Обновить»** сначала запускает синхронизацию INBOX (`POST /api/email/fetch`), затем обновляет список тикетов. Появившиеся из почты записи отображаются в той же таблице (источник `source=email`).
- Дубликаты не создаются: по заголовку Message-ID (`external_id`) проверяется наличие записи в БД.
- **Railway Cron Job** (или другой планировщик): для периодической синхронизации каждую минуту вызывайте `POST /api/cron/sync-inbox` с заголовком `X-Cron-Secret: <CRON_SECRET>`. В `backend/.env` задайте `CRON_SECRET` (произвольная строка). Без этого заголовка эндпоинт возвращает 403.

Остальные (порты, режим почты, IMAP/SMTP и т.д.) описаны в корневом `.env.example` и при необходимости задаются там же.

---

## 6. Сценарий использования (демо)

1. **Главная страница** (http://localhost:3000) — выбор роли: «Пользователь» или «Админ».
2. **Пользователь** — «Создать обращение»: форма (email, тема, текст, ФИО и др.). После отправки тикет попадает в список «Мои обращения» (привязка по токену устройства в браузере). В списке можно открыть детали своего тикета (без ответа ИИ и без админ-функций).
3. **Админ** — переход к странице входа; после ввода кода доступа открывается панель со списком всех тикетов. Доступны фильтры, колонки (в т.ч. категория, «Требуется оператор», прибор). Открытие тикета показывает детали, ответ ИИ и метку оператора.
4. **Демо-данные** — в админ-панели кнопка «Seed демо» вызывает `POST /api/seed-demo`. Создаётся набор тикетов, для каждого выполняется тот же ИИ-пайплайн (категория, тон, оператор, ответ и т.д.), так что демо повторяет поведение реальных обращений.

---

## 7. Возможные проблемы

- **Порт уже занят** — если 3000 или 8000 заняты, в логах будет ошибка. Можно остановить другой процесс на этом порту или поменять порт в конфигурации/команде запуска.
- **Файл .env не найден** — скрипты `setup.sh` / `setup.bat` создают `.env` из `.env.example` только при первом запуске. Если файла нет, его можно скопировать вручную из `.env.example` и отредактировать.
- **Ошибка подключения к БД** — при локальном запуске без Docker проверьте `DATABASE_URL` или включите `USE_SQLITE=1`. При Docker убедитесь, что контейнер `db` запущен и backend обращается к хосту `db` и порту 5432.
- **ИИ не даёт «живой» ответ** — без корректного `OPENAI_API_KEY` в `.env` backend работает в режиме заглушки (шаблонные ответы). Достаточно задать ключ в корневом `.env` или в `backend/.env` и перезапустить backend.

---

## 8. Лицензия и примечания

Проект создан в учебных/демонстрационных целях. Состав и описание соответствуют текущему состоянию репозитория (структура, Makefile, скрипты setup, docker-compose, эндпоинты и сценарии опираются на реальные файлы проекта).

---

*README составлен по структуре репозитория: `Makefile`, `setup.sh`, `setup.bat`, `docker-compose.yml`, `backend/requirements.txt`, `backend/Dockerfile`, `backend/app/config.py`, `frontend/package.json`, `frontend/Dockerfile`, `.env.example`, `backend/.env.example`, `frontend/.env.example`, роутеры и сервисы backend/frontend.*
